---
layout: post
title:  "vasp计算流程"
date:   2018-01-23 22:30:00 +0800
categories: DFT
tags: vasp
author: cndaqiang
mathjax: true
---
* content
{:toc}

VASP主要计算流程:结构优化、静态自洽、非自洽计算



# 参考
[VASP 结构优化、静态自洽、非自洽计算](http://blog.csdn.net/kyang_823/article/details/59110848)
# 计算过程
## 结构优化
结构优化是指对整个输入体系的坐标进行调整，得到一个相对稳定的基态结构,因此可以得到体系的总能量、晶体结构参数.
<br>结构优化分离子优化和电子优化两个嵌套的过程，优化的过程输出到`OSZICAR`文件,如下,`DAV: n`是电子优化嵌套在`n F= ...`离子优化中
```
       N       E                     dE             d eps       ncg     rms          rms(c)
DAV:   1     0.792799315692E+02    0.79280E+02   -0.34288E+03    64   0.507E+02
...省略
DAV:  21     0.264558511708E+00    0.53910E-04   -0.16164E-07    24   0.401E-03
   1 F= 0.26455851E+00 E0= 0.26435292E+00  d E =0.264559E+00  mag=     2.0000
       N       E                     dE             d eps       ncg     rms          rms(c)
DAV:   1     0.143272113174E+03    0.14301E+03   -0.50023E+03    64   0.387E+02    0.379E+01
省略
```
优化后晶格参数和原子位置等结果输出到`CONTCAR`文件(格式同POSCAR),结构优化完成后，`cp CONTCAR POSCAR`进行下一步的静态自洽计算，对电子结构做进一步调整

### 结构优化的参数：
#### IBRION 
- IBRION=2：共轭梯度算法(CG)，**一般来说都用它**
<br>CG方法慢一些，找到全局最小的可能性也要大一些。
- IBRION=1：准牛顿方法(quasi-Newton RMM-DIIS),用于小范围内稳定结构的搜索
<br>准牛顿方法计算速度较快，适合于初始结构与平衡结构(势能面上全局最小值)比较接近的情况
- IBRION其他取值用于其他计算

#### EDIFF EDIFFG NELM NSW ISIF 
- EDIFF电子收敛标准 
- EDIFFG原子收敛标准
- NELM电子优化(SCF)最大计算步数(默认60)
- NELMIN电子优化的最小步数。默认为2，一般不设置
- NSW离子优化最大步数,默认0(不优化),必须设置
- POTIM调整离子位置移动的大小,默认0.5,需要设置
- NFREE确定每个方向和离子使用多少个位移
<br>(计算频率使用,优化结构无需设置?)
- ISIF控制离子运动中晶胞的变化情况
<br>IBRION=0时默认0,其他情况默认2，常用2,3
![](/uploads/2018/01/isif.JPG)
- 参数的详细内容参考[VASP输入文件总结](/2018/01/21/vasp-input/#ibrion-nfree-nsw-isif)和官方**[manual](http://cms.mpi.univie.ac.at/vasp/vasp/vasp.html)**

参数是互相联系的,比如精度大了,优化步数肯定就要增加<br>
初始时结构不合理,原子距离太近,POTIM就要设置的小一些，不然很难收敛


### 分析
收敛性主要影响因素：初始结构的合理性和弛豫参数的设置
结构优化分电子迭代和离子弛豫两个嵌套的过程。
- 电子迭代自洽的速度，主要影响因素：初始结构的合理性，k点密度，是否考虑自旋和高斯展宽（SIGMA）；
- 离子弛豫的收敛速度，主要影响因素：弛豫方法（IBRION）,步长（POTIM）和收敛判据（EDIFFG）
#### 初始结构设置
比较好的设置方法可以参照键长。比如CO在O顶位的吸附，可以参照CO2中C-O键长来设置（如增长20%）。也可以参照文献。记住一些常见键长，典型晶体中原子间距离等参数，有助于提高初始结构设置的合理性。实在不行，可以先在小体系上测试，然后再放到大体系中算。
#### 弛豫参数
根据[VASP 结构优化、静态自洽、非自洽计算](http://blog.csdn.net/kyang_823/article/details/59110848)的说法
- 针对理论催化的计算，初始结构都是不太合理的。因此一开始采用很粗糙的优化（EDIFF=1E-3，EDIFFG= -0.2），很低的K点密度(Gamma)，不考虑自旋就可以了，这样NSW<60的设置就比较好。其它参数可以默认。<br>
经过第一轮优化，就可以进入下一步细致的优化了。就[VASP 结构优化、静态自洽、非自洽计算](http://blog.csdn.net/kyang_823/article/details/59110848)的经验，EDIFF=1E-4,EDIFFG=-0.05，不考虑自旋，IBRION=2，其它默认，NSW=100;跑完后可以设置IBRION = 1，减小OPTIM（默认为0.5，可以设置0.2）继续优化。
<br>优化的时候让它自己闷头跑是不对的，经常看看中间过程，根据情况调节优化参数是可以很好的提高优化速度。这个时候，提**交两个以上的任务排队是好的方式，一个在调整的时候，下一个可以接着运行**
- 如果电子步不能在40步内收敛，要么是参数设置的问题，要么是初始模型太糟糕（糟糕的不是一点点）。
- 静态自洽过程电子步不收敛一般是参数设置有问题。这个时候，改变迭代算法（ALGO），提高高斯展宽（SIGMA增加）,设置自洽延迟（NELMDL）都是不错的方法。对于大体系比较难收敛的话，可以先调节AMIN,BMIX跑十多步，得到电荷密度和波函数，再重新计算。实在没办法了，可以先放任它跑40步，没有收敛的迹象的话，停下来，得到电荷密度和波函数后重新计算。一般都能在40步内收敛。

对于离子弛豫过程，不调节关系也不大。开始两个离子步电子迭代可能要跑满60步（默认的），后面就会越来越快了。

总的说来，一般入门者，多看手册，多想多理解，多上机实践总结，比较容易提高到一个熟练操作工的水平。

如果要想做到“精确打击”，做到能在问题始发的时候就立刻采取有效措施来解决，就需要回归基础理论和计算方法上来了。



迟豫收敛判据（强制停止）的选择：
结构弛豫的判据一般有两种选择：能量和力。这两者是相关的，理想情况下，能量收敛到基态，力也应该是收敛到平衡态的。但是数值计算过程上的差异导致以二者为判据的收敛速度差异很大，力收敛速度绝大部分情况下都慢于能量收敛速度。这是因为力的计算是在能量的基础上进行的，能量对坐标的一阶导数得到力。计算量的增大和误差的传递导致力收敛慢。

到底是以能量为收敛判据，还是以力为收敛判据呢？关心能量的人，觉得以能量为判据就够了；关心力相关量的人，用力作为收敛标准。

对于超胞体系的结构优化，文献大部分采用Gamma点做单点优化。这个时候即使采用力为判据（EDIFFG=-0.02），在做静态自洽计算能量的时候，会发现，原本已经收敛得好好的力在不少敏感位置还是超过了结构优化时设置的标准。这个时候，是不是该怀疑对超胞仅做Gamma点结构优化的合理性呢？是不是要提高K点密度再做结构优化呢。

在我看来，这取决于所研究的问题的复杂程度。我们的计算从原胞开始，到超胞，到掺杂结构，到吸附结构，到反应和解离。每一步都在增加复杂程度。结构优化终点与初始结构是有关的，如果遇到对初始结构敏感的优化，那就头疼了。而且，还要注意到，催化反应不仅与原子本身及其化学环境有关，还会与几何构型有关。气固催化反应过程是电子的传递过程，也是分子拆分与重新组合的过程。如果优化终点的构型不同，可能会导致化学反应的途径上的差异。仅从这一点来看，第一性原理计算的复杂性，结果上的合理性判断都不是手册上写的那么简单。

对于涉及构型敏感性的结构优化过程，我觉得，以力作为收敛判据更合适。而且需要在Gamma点优化的基础上再提高K点密度继续优化，直到静态自洽计算时力达到收敛标准的。




促进收敛的方法：
费米面附近能级电子分布的smearing是一种促进收敛的有效方法，可能产生物理意义不明确的分数占据态情况，不过问题不大。在INCAR文件中以ISMEAR来设置。一般来说K点只有一两个的时候采用ISMEAR=0，金属体材料用ISMEAR=1或2,半导体材料用ISMEAR=-5等等。

不过有时电子步收敛速度依然很慢，还需要设置一些算法控制选项，例如设置ALGO=Very_Fast，减小真空层厚度，减少K点数目等。



带限制条件的迟豫计算：
有的时候我们需要一些带限制条件的弛豫计算，例如冻结部分原子、限制自旋的计算等等。冻结部分原子可以在POSCAR文件中设置selectivedynamic来实现。自旋多重度限制可以在INCAR中以NUPDOWN选项来设置。另外ISIF选项可以控制弛豫时的晶胞变化情况，例如晶胞的形状和体积等。



第二步：静态自洽计算

静态：原子位置保持不动，不再进行原子迟豫（？？？是否正确）；
自洽：电子再进行自洽计算；
因此，静态自洽计算是在结构优化的基础上，在体系能量达到 较低、体系 较稳定 的情况下固定原子的位置坐标，再对体系中的电子进行调整，以达到体系的 最低能量。

因此，静态自洽计算前需要提供 较稳定体系 的晶格结构信息（即结构优化完的CONTCAR），从而通过电子自洽计算 （通过自洽迭代求解薛定谔方程（微观中描述电子的状态，相当于宏观的运动方程））  完整地计算出 体系基态下费米能级（准确值，The fermi level location is accurate only in self-consistent calculation.）、 电子的波函数、电荷密度等信息，可以直接分析原子间的键合作用，也可以在非自洽之后进一步分析晶体的电子结构和材料的相关性质。

静态自洽计算的准备工作：
使用结构优化输出的CONTCAR拷贝成新的POSCAR
静态自洽主要涉及的参数：
NSW=0  不再进行原子迟豫
LWAVE=.TRUE  （需要在WAVECAR中输出波函数）
LCHARGE=.TRUE    （需要在CHG和CHGCAR中输出电荷密度）


注释：第一步和第二部都含有电子迭代的自洽计算。第三步开始都不是非自洽计算。

第三步：非自洽计算

非自洽计算是在自洽基础上改变k点（重新生成k点）等参数，根据不同需要选取能量或势函数或电子密度作为初始值，进行非自洽迭代计算，可用于求解DOS，能带（电子结构分析）或者光学等其他性质。

——>非自洽计算可以得到EIGENCAR文件，与syml文件通过脚本做能带和态密度性质。


能带的非自洽计算在侯博士的手册中有讲。下面只是一些重要的地方。

重新生成k点：
syml文件：需要静态自洽计算之后输出的OUTCAR中的基矢和倒基矢、费米能级（准确值）；  取高对称点路径以及分割点数。
具体以以下格式书写：
6   
30  20  30  20  30
G 0.0    0.0    0.0
M 0.0    0.5    0.0
K -0.333333333333   0.6666666666667   0.0
G 0.0    0.0    0.0
A 0.0    0.0    0.5
L 0.0    0.5    0.5
0.000000000 -4.052756964  0.000000000     0.142458646 -0.246745613  0.000000000
3.509790486  2.026378482  0.000000000     0.284917292  0.000000000  0.000000000
0.000000000  0.000000000  5.572964774     0.000000000  0.000000000  0.179437703
-20.0  20.0
0.0

上面每一行意思：
#############comment
1 line: nhighk   !how many high symmetry k-points
2     : ndiv(i)  !number of grid points between two symmetry k-points
3     : labhk(i), phighk(i,j)   !label of high sysmmetry k-points, coordinates
......
9     : a(i,j),b(i,j)   !direct & reciprocal lattice vectors
......
12    : emin, emax   ! energy width of band plot
13    : efermi       ! fermi level
##############
\\\ G--M--K--G--A---L   NKPT=131
\\\ 1--31--51--81--101---131
--------------------------------------------
Hex
M:0.0    0.5    0.0
G:0.0    0.0    0.0
H:-1/3   2/3    0.5
K:-1/3   2/3    0.0
L:0.0    0.5    0.5
A:0.0    0.0    0.5

kpoints有几种生成方式：自动模式，line模式（用于能带计算），全手动模式，用SYML作为输入文件使用gk.f编译的程序生成。
不同的方式有不同的用途：
auto的方式，除了不能用在能带计算中，其他的都可以用到。
line模式，只用在能带的计算中。
syml的模式，也只是用在能带计算中。这个的功能等同于line 模式，只是自己手动产生而已。

涉及的参数设置：
ISTART=1  （接着计算）
ICHAGE=11   （读入自洽的CHGCAR，从而开始能带或者态密度的非自洽计算）
NSW=0  （不再进行原子迟豫）




注：结构优化和静态自洽计算都设置ISTART=0，因此都是从头开始新的计算，因此会刷新各个文件中的数据，所以拷贝文件要全。同理，非自洽计算设置ISTART=1，即进行接着算，也要注意文件内容。
